import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:newwwwwwww/features/cart/presentation/widgets/delivery_address_cart.dart';
import 'package:newwwwwwww/features/cart/presentation/widgets/outline_buttons.dart';
import 'package:newwwwwwww/features/favourites/domain/models/favorite_product.dart';
import 'package:newwwwwwww/features/orders/domain/models/order_model.dart';
import 'package:newwwwwwww/features/orders/presentation/widgets/order_summary_card.dart';
import 'package:newwwwwwww/features/home/domain/models/product_model.dart';
import '../../../../core/theme/colors.dart';
import '../../../favourites/pesentation/widgets/favourite_product_card.dart';
import '../../../home/presentation/widgets/background_home_Appbar.dart';
import '../../../home/presentation/widgets/build_ForegroundAppBarHome.dart';
import '../../../home/presentation/widgets/main_screen_widgets/suppliers/build_info_button.dart';
import '../../../home/presentation/bloc/cart/cart_bloc.dart';
import '../../../home/presentation/bloc/cart/cart_state.dart';
import '../../../profile/presentation/widgets/add_new_address_alert.dart';
import '../widgets/cart_store_card.dart';
import '../widgets/payment_method_alert.dart';

// Helper function to create ClientOrder from cart items
ClientOrder _createOrderFromCart(List<Object> cartItems) {
  double subtotal = 0.0;
  
  // Calculate subtotal from cart items
  for (final item in cartItems) {
    if (item is Map<String, dynamic>) {
      // Handle new product data structure
      final price = (item['price'] as num?)?.toDouble() ?? 0.0;
      subtotal += price;
    } else if (item.toString().contains('Product')) {
      // Handle old string format for backward compatibility
      subtotal += 25.0; // Default price per item
    }
  }
  
  // Calculate delivery cost (you can make this dynamic)
  final deliveryCost = 10.0;
  
  // Calculate total
  final total = subtotal + deliveryCost;
  
  return ClientOrder(
    id: 0,
    subTotal: subtotal,
    discount: 0.0,
    deliveryCost: deliveryCost,
    total: total,
    isPaid: false,
    items: cartItems,
  );
}

class CartScreen extends StatefulWidget {
  @override
  State<CartScreen> createState() => _CartScreenState();
}

class _CartScreenState extends State<CartScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    _tabController = TabController(length: 4, vsync: this);
    super.initState();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  String? imageUrl = null;
  List<String> products = [
    'assets/images/home/main_page/product.jpg',
    'assets/images/home/main_page/product.jpg',
    'assets/images/home/main_page/product.jpg',
  ];

  @override
  Widget build(BuildContext context) {
    final screenHeight = MediaQuery.of(context).size.height;
    final screenWidth = MediaQuery.of(context).size.width;
    return GestureDetector(
      onTap: () => FocusScope.of(context).unfocus(),
      child: Scaffold(
        extendBodyBehindAppBar: true,
        // üî• ŸäÿÆŸÑŸä ÿßŸÑÿ¨ÿ≥ŸÖ Ÿäÿ®ÿØÿ£ ŸÖŸÜ ÿ£ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿÆŸÑŸÅ ÿßŸÑŸÄ AppBar
        backgroundColor: Colors.transparent,
        // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸàÿ±ÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
        body: Stack(
          children: [
            Container(
              width: screenWidth,
              height: screenHeight,
              color: AppColors.backgrounHome,
            ),
            buildBackgroundAppbar(screenWidth),
            BuildForegroundappbarhome(
              screenHeight: screenHeight,
              screenWidth: screenWidth,
              title: 'Your Cart',
              is_returned: true,
              disabledCart: 'cart',
            ),
            Positioned.fill(
              top: MediaQuery.of(context).padding.top + screenHeight * .1,
              child: Padding(
                padding: EdgeInsets.only(
             //     top: screenHeight * .03,//04 handle design shimaa
                  bottom: screenHeight * .1,
                ),
                child: SingleChildScrollView(
                  child: Padding(
                    padding: EdgeInsets.only(
                      bottom: MediaQuery.of(context).viewInsets.bottom,
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisAlignment: MainAxisAlignment.start,
                      children: [
                        Padding(
                          padding: EdgeInsets.symmetric(
                            horizontal: screenWidth * .06,
                          ),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisAlignment: MainAxisAlignment.start,
                            children: [
                              CartStoreCard(context, screenWidth, screenHeight),

                              Padding(
                                padding: EdgeInsets.symmetric(
                                  vertical: screenHeight * .02,
                                ),
                                child: BlocBuilder<CartBloc, CartState>(
                                  builder: (context, cartState) {
                                    if (cartState.cartProducts.isEmpty) {
                                      return Center(
                                        child: Column(
                                          children: [
                                            Icon(
                                              Icons.shopping_cart_outlined,
                                              size: screenWidth * .1,
                                              color: Colors.grey[400],
                                            ),
                                            SizedBox(height: screenHeight * .02),
                                            Text(
                                              'Your cart is empty',
                                              style: TextStyle(
                                                color: Colors.grey[600],
                                                fontSize: screenWidth * .04,
                                              ),
                                            ),
                                          ],
                                        ),
                                      );
                                    }

                                    return Column(
                                      children: cartState.cartProducts
                                          .map((product) {
                                            // Check if product is Map with real data
                                            if (product is Map<String, dynamic>) {
                                              return Padding(
                                                padding: EdgeInsets.only(bottom: screenHeight * .02),
                                                child: FavouriteProductCard(
                                                  screenWidth: screenWidth,
                                                  screenHeight: screenHeight,
                                                  favouriteProduct: FavoriteProduct(
                                                    id: product['id'] ?? 0,
                                                    productVsId: product['id'] ?? 0,
                                                    createdAt: DateTime.now(),
                                                    product: FavoriteProductItem(
                                                      id: product['id'] ?? 0,
                                                      vsId: product['id'] ?? 0,
                                                      enName: product['name'] ?? 'Product',
                                                      arName: product['name'] ?? 'ŸÖŸÜÿ™ÿ¨',
                                                      isActive: true,
                                                      isCurrent: true,
                                                      price: (product['price'] as num?)?.toDouble() ?? 0.0,
                                                      categoryId: 0,
                                                      categoryName: 'General',
                                                      images: [],
                                                      totalAvailableQuantity: 0,
                                                      inventory: [],
                                                    ),
                                                  ),
                                                  fromCartScreen: true,
                                                ),
                                              );
                                            } else if (product is ClientProduct) {
                                              return Padding(
                                                padding: EdgeInsets.only(bottom: screenHeight * .02),
                                                child: FavouriteProductCard(
                                                  screenWidth: screenWidth,
                                                  screenHeight: screenHeight,
                                                  favouriteProduct: FavoriteProduct(
                                                    id: product.id,
                                                    productVsId: product.vsId,
                                                    createdAt: DateTime.now(),
                                                    product: FavoriteProductItem(
                                                      id: product.id,
                                                      vsId: product.vsId,
                                                      enName: product.enName,
                                                      arName: product.arName,
                                                      isActive: product.isActive,
                                                      isCurrent: product.isCurrent,
                                                      price: product.price,
                                                      categoryId: product.categoryId,
                                                      categoryName: product.categoryName,
                                                      images: product.images,
                                                      totalAvailableQuantity: product.totalAvailableQuantity,
                                                      inventory: product.inventory,
                                                    ),
                                                  ),
                                                  fromCartScreen: true,
                                                ),
                                              );
                                            } else {
                                              // Handle old string format for backward compatibility
                                              return Padding(
                                                padding: EdgeInsets.only(bottom: screenHeight * .02),
                                                child: FavouriteProductCard(
                                                  screenWidth: screenWidth,
                                                  screenHeight: screenHeight,
                                                  favouriteProduct: FavoriteProduct(
                                                    id: 0,
                                                    productVsId: 0,
                                                    createdAt: DateTime.now(),
                                                    product: FavoriteProductItem(
                                                      id: 0,
                                                      vsId: 0,
                                                      enName: product.toString(),
                                                      arName: product.toString(),
                                                      isActive: false,
                                                      isCurrent: false,
                                                      price: 0,
                                                      categoryId: 0,
                                                      categoryName: 'Unknown',
                                                      images: [],
                                                      totalAvailableQuantity: 0,
                                                      inventory: [],
                                                    ),
                                                  ),
                                                  fromCartScreen: true,
                                                ),
                                              );
                                            }
                                          })
                                          .toList(),
                                    );
                                  },
                                ),
                                //                   FavouriteProductCard(screenWidth: screenWidth,screenHeight:  screenHeight,
                                //                     icon: 'assets/images/home/main_page/product.jpg',fromCartScreen:true
                                //                   ),
                                //                   FavouriteProductCard(screenWidth: screenWidth,screenHeight:  screenHeight,
                                //                       icon: 'assets/images/home/main_page/product.jpg',fromCartScreen:true
                                //                   ), FavouriteProductCard(screenWidth: screenWidth,screenHeight:  screenHeight,
                                //                       icon: 'assets/images/home/main_page/product.jpg',fromCartScreen:true
                                //                   ),
                                //
                                //
                                //                 ],),
                                //ŸÜ             ),
                              ),
                              BlocBuilder<CartBloc, CartState>(
                                builder: (context, cartState) {
                                  return OrderSummaryCard(
                                    screenWidth, 
                                    screenHeight, 
                                    _createOrderFromCart(cartState.cartProducts)
                                  );
                                },
                              ),
                              OrderDeliveryCartWidget(),
                              BuildInfoAndAddToCartButton(
                                screenWidth,
                                screenHeight,
                                'Proceed To Checkout',
                                false,
                                () {
                                  showDialog(
                                    context: context,
                                    builder: (ctx) => PaymentMethodAlert(),
                                  );
                                },
                              ),
                              RowOutlineButtons(
                                context,
                                screenWidth,
                                screenHeight,
                                'Continue Shopping',
                                'Clear Cart',
                                () {},
                                () {},
                              ),
                              SizedBox(height: screenHeight * .04),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
